<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://cdn.jsdelivr.net; script-src 'unsafe-inline'">
    <title>中文记忆助手 - Chinese Memorization Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --correct-color: #d4edda;
            --incorrect-color: #f8d7da;
        }
        .hanzi { font-size: 1.5rem; line-height: 2rem; }
        .correct { background-color: var(--correct-color); }
        .incorrect { background-color: var(--incorrect-color); }
        .comparison-column { border: 1px solid #dee2e6; border-radius: 0.25rem; padding: 1rem; }
        #voice-status { font-size: 0.9rem; color: #6c757d; }
        .flashcard-container { min-height: 200px; cursor: pointer; }
        @media (max-width: 768px) {
            .hanzi { font-size: 1.2rem; }
            .btn { padding: 0.5rem 1rem; }
            .comparison-column { margin-bottom: 1rem; }
        }
    </style>
</head>
<body class="container py-4">
    <!-- Text Input Section -->
    <section class="mb-4">
        <h2 class="h4 mb-3">输入中文文本</h2>
        <textarea id="input-text" class="form-control" rows="4" 
                  placeholder="粘贴或输入中文文本..."></textarea>
        <button class="btn btn-primary mt-2" onclick="processText()">开始练习</button>
    </section>

    <!-- Practice Modules -->
    <div class="row g-4">
        <!-- Flashcards -->
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">生词卡</h5>
                    <div id="flashcard" class="flashcard-container d-flex align-items-center justify-content-center hanzi" 
                         onclick="flipCard()"></div>
                    <div class="text-center mt-3">
                        <div class="btn-group">
                            <button class="btn btn-outline-secondary btn-sm" 
                                    onclick="currentCardIndex--; updateCard()">← 前</button>
                            <button class="btn btn-outline-secondary btn-sm" 
                                    onclick="showPinyin=!showPinyin; updateCard()">拼音</button>
                            <button class="btn btn-outline-secondary btn-sm" 
                                    onclick="currentCardIndex++; updateCard()">后 →</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fill-in-the-Blank -->
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">填空练习</h5>
                    <div id="blank-exercise" class="hanzi mb-3"></div>
                    <input type="text" id="blank-input" class="form-control" 
                           placeholder="输入空格内容">
                    <button class="btn btn-primary mt-2" onclick="checkBlank()">检查答案</button>
                </div>
            </div>
        </div>

        <!-- Typing Practice -->
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">打字练习</h5>
                    <div id="typing-prompt" class="hanzi mb-3"></div>
                    <input type="text" id="typing-input" class="form-control" 
                           placeholder="输入或语音录入">
                    <div class="mt-2">
                        <button class="btn btn-primary" onclick="startVoiceInput()" 
                                id="voice-btn">🎤 语音输入</button>
                        <span id="voice-status"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Text Comparison -->
    <section class="row mt-4">
        <div class="col-md-6 comparison-column mb-3">
            <h5 class="mb-3">原文对照</h5>
            <div id="original-text" class="hanzi"></div>
        </div>
        <div class="col-md-6 comparison-column mb-3">
            <h5 class="mb-3">你的输入</h5>
            <div id="user-text" class="hanzi"></div>
        </div>
    </section>

    <!-- Footer Section -->
    <footer class="mt-4 text-center">
        <button class="btn btn-outline-primary" onclick="shareProgress()">
            ↪️ 分享进度
        </button>
        <div class="text-muted mt-3 small">
            使用 <a href="https://github.com/zh-lx/pinyin-pro" target="_blank" rel="noopener">pinyin-pro</a> 库 (MIT License)
            <br>
            语音识别功能需要Chrome/Edge浏览器
        </div>
    </footer>

    <script>
        // State Management
        let currentText = [];
        let showPinyin = false;
        let currentCardIndex = 0;
        let blankPositions = [];
        let recognition;

        // Text Processing
        function processText() {
            const input = document.getElementById('input-text').value;
            
            if (!/[\u4e00-\u9fa5]/.test(input)) {
                alert("请输入包含中文的文本!");
                return;
            }

            currentText = input.split('').filter(c => c.trim());
            sessionStorage.setItem('currentText', JSON.stringify(currentText));
            
            initFlashcards();
            initFillInBlank();
            initTypingPractice();
            showOriginalText();
        }

        // Flashcards Module
        function initFlashcards() {
            currentCardIndex = Math.max(0, Math.min(currentCardIndex, currentText.length - 1));
            updateCard();
        }

        function updateCard() {
            const card = document.getElementById('flashcard');
            if (currentCardIndex >= 0 && currentCardIndex < currentText.length) {
                card.textContent = currentText[currentCardIndex];
                card.dataset.pinyin = showPinyin ? getPinyin(currentText[currentCardIndex]) : '';
            }
        }

        function flipCard() {
            const card = document.getElementById('flashcard');
            card.textContent = card.textContent === card.dataset.pinyin 
                ? currentText[currentCardIndex] 
                : card.dataset.pinyin;
        }

        // Fill-in-the-Blank Module
        function initFillInBlank() {
            blankPositions = [];
            const exercise = currentText.map((char, i) => {
                if (i % 3 === 0) {
                    blankPositions.push(i);
                    return '_';
                }
                return char;
            }).join('');
            document.getElementById('blank-exercise').textContent = exercise;
        }

        function checkBlank() {
            const userAnswers = document.getElementById('blank-input').value.split('');
            const display = currentText.map((char, i) => {
                const blankIndex = blankPositions.indexOf(i);
                if (blankIndex > -1) {
                    const userChar = userAnswers[blankIndex] || '_';
                    const cls = userChar === char ? 'correct' : 'incorrect';
                    return `<span class="${cls}">${userChar}</span>`;
                }
                return char;
            }).join('');
            
            document.getElementById('blank-exercise').innerHTML = display;
        }

        // Typing & Voice Module
        function initTypingPractice() {
            document.getElementById('typing-prompt').textContent = currentText.join('');
            document.getElementById('typing-input').value = '';
            document.getElementById('typing-input').oninput = function(e) {
                highlightComparison(currentText.join(''), e.target.value);
            }
        }

        function startVoiceInput() {
            if (window.location.protocol !== 'https:') {
                alert("语音输入需要HTTPS安全连接!");
                return;
            }

            if (!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) {
                alert("当前浏览器不支持语音输入!");
                return;
            }

            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'zh-CN';
            recognition.continuous = false;
            
            recognition.onresult = (event) => {
                const result = event.results[0][0].transcript;
                document.getElementById('typing-input').value = result;
                highlightComparison(currentText.join(''), result);
            };

            recognition.onerror = (event) => {
                document.getElementById('voice-status').textContent = `错误: ${event.error}`;
            };

            recognition.onend = () => {
                document.getElementById('voice-status').textContent = "";
            };

            recognition.start();
            document.getElementById('voice-status').textContent = "正在聆听...";
        }

        // Text Comparison
        function showOriginalText() {
            document.getElementById('original-text').textContent = currentText.join('');
        }

        function highlightComparison(original, userInput) {
            const userDisplay = document.getElementById('user-text');
            userDisplay.innerHTML = Array.from(userInput).map((c, i) => {
                const originalChar = original[i] || '';
                return `<span class="${originalChar === c ? 'correct' : 'incorrect'}">${c}</span>`;
            }).join('');
        }

        // Pinyin Conversion
        function getPinyin(char) {
            if (!window.pinyinPro) {
                console.error("拼音库未正确加载!");
                return char;
            }
            return window.pinyinPro.convertToPinyin(char, ' ', true, true) || char;
        }

        // Social Sharing
        function shareProgress() {
            const text = `我正在练习中文：${currentText.slice(0, 20).join('')}...\n试试这个工具：${location.href}`;
            
            if (navigator.share) {
                navigator.share({ text }).catch(() => {
                    prompt("请手动复制分享内容:", text);
                });
            } else if (navigator.clipboard) {
                navigator.clipboard.writeText(text)
                    .then(() => alert("已复制分享链接到剪贴板!"))
                    .catch(() => prompt("复制以下内容分享:", text));
            } else {
                prompt("复制以下内容分享:", text);
            }
        }

        // Session Persistence
        window.addEventListener('load', () => {
            const savedText = sessionStorage.getItem('currentText');
            if (savedText) {
                try {
                    document.getElementById('input-text').value = JSON.parse(savedText).join('');
                    processText();
                } catch (e) {
                    sessionStorage.removeItem('currentText');
                }
            }
        });

        // Error Handling
        window.addEventListener('error', (e) => {
            console.error(e);
            alert(`操作失败: ${e.message}`);
        });

        // Load Pinyin Library
        (function loadPinyin() {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/pinyin-pro@3.14.3/dist/web/pinyin-pro.js';
            script.integrity = "sha384-4X6YVJgD4jC9T/3+5E6Xp4Z5XpwQwLSP7Fxvu0Zwr0Y0SOU5N6TZQ5fJ5Z5C5A==";
            script.crossOrigin = "anonymous";
            script.async = true;
            script.onerror = () => {
                alert("拼音库加载失败，部分功能可能受限!");
            };
            document.head.appendChild(script);
        })();
    </script>
</body>
</html>
