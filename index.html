<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://cdn.jsdelivr.net; script-src 'unsafe-inline'">
    <title>ä¸­æ–‡è®°å¿†åŠ©æ‰‹ - Chinese Memorization Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --correct-color: #d4edda;
            --incorrect-color: #f8d7da;
        }
        .hanzi { font-size: 1.5rem; line-height: 2rem; }
        .correct { background-color: var(--correct-color); }
        .incorrect { background-color: var(--incorrect-color); }
        .comparison-column { border: 1px solid #dee2e6; border-radius: 0.25rem; padding: 1rem; }
        #voice-status { font-size: 0.9rem; color: #6c757d; }
        .flashcard-container { min-height: 200px; cursor: pointer; }
        @media (max-width: 768px) {
            .hanzi { font-size: 1.2rem; }
            .btn { padding: 0.5rem 1rem; }
            .comparison-column { margin-bottom: 1rem; }
        }
    </style>
</head>
<body class="container py-4">
    <!-- Text Input Section -->
    <section class="mb-4">
        <h2 class="h4 mb-3">è¾“å…¥ä¸­æ–‡æ–‡æœ¬</h2>
        <textarea id="input-text" class="form-control" rows="4" 
                  placeholder="ç²˜è´´æˆ–è¾“å…¥ä¸­æ–‡æ–‡æœ¬..."></textarea>
        <button class="btn btn-primary mt-2" onclick="processText()">å¼€å§‹ç»ƒä¹ </button>
    </section>

    <!-- Practice Modules -->
    <div class="row g-4">
        <!-- Flashcards -->
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">ç”Ÿè¯å¡</h5>
                    <div id="flashcard" class="flashcard-container d-flex align-items-center justify-content-center hanzi" 
                         onclick="flipCard()"></div>
                    <div class="text-center mt-3">
                        <div class="btn-group">
                            <button class="btn btn-outline-secondary btn-sm" 
                                    onclick="currentCardIndex--; updateCard()">â† å‰</button>
                            <button class="btn btn-outline-secondary btn-sm" 
                                    onclick="showPinyin=!showPinyin; updateCard()">æ‹¼éŸ³</button>
                            <button class="btn btn-outline-secondary btn-sm" 
                                    onclick="currentCardIndex++; updateCard()">å â†’</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fill-in-the-Blank -->
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">å¡«ç©ºç»ƒä¹ </h5>
                    <div id="blank-exercise" class="hanzi mb-3"></div>
                    <input type="text" id="blank-input" class="form-control" 
                           placeholder="è¾“å…¥ç©ºæ ¼å†…å®¹">
                    <button class="btn btn-primary mt-2" onclick="checkBlank()">æ£€æŸ¥ç­”æ¡ˆ</button>
                </div>
            </div>
        </div>

        <!-- Typing Practice -->
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">æ‰“å­—ç»ƒä¹ </h5>
                    <div id="typing-prompt" class="hanzi mb-3"></div>
                    <input type="text" id="typing-input" class="form-control" 
                           placeholder="è¾“å…¥æˆ–è¯­éŸ³å½•å…¥">
                    <div class="mt-2">
                        <button class="btn btn-primary" onclick="startVoiceInput()" 
                                id="voice-btn">ğŸ¤ è¯­éŸ³è¾“å…¥</button>
                        <span id="voice-status"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Text Comparison -->
    <section class="row mt-4">
        <div class="col-md-6 comparison-column mb-3">
            <h5 class="mb-3">åŸæ–‡å¯¹ç…§</h5>
            <div id="original-text" class="hanzi"></div>
        </div>
        <div class="col-md-6 comparison-column mb-3">
            <h5 class="mb-3">ä½ çš„è¾“å…¥</h5>
            <div id="user-text" class="hanzi"></div>
        </div>
    </section>

    <!-- Footer Section -->
    <footer class="mt-4 text-center">
        <button class="btn btn-outline-primary" onclick="shareProgress()">
            â†ªï¸ åˆ†äº«è¿›åº¦
        </button>
        <div class="text-muted mt-3 small">
            ä½¿ç”¨ <a href="https://github.com/zh-lx/pinyin-pro" target="_blank" rel="noopener">pinyin-pro</a> åº“ (MIT License)
            <br>
            è¯­éŸ³è¯†åˆ«åŠŸèƒ½éœ€è¦Chrome/Edgeæµè§ˆå™¨
        </div>
    </footer>

    <script>
        // State Management
        let currentText = [];
        let showPinyin = false;
        let currentCardIndex = 0;
        let blankPositions = [];
        let recognition;

        // Text Processing
        function processText() {
            const input = document.getElementById('input-text').value;
            
            if (!/[\u4e00-\u9fa5]/.test(input)) {
                alert("è¯·è¾“å…¥åŒ…å«ä¸­æ–‡çš„æ–‡æœ¬!");
                return;
            }

            currentText = input.split('').filter(c => c.trim());
            sessionStorage.setItem('currentText', JSON.stringify(currentText));
            
            initFlashcards();
            initFillInBlank();
            initTypingPractice();
            showOriginalText();
        }

        // Flashcards Module
        function initFlashcards() {
            currentCardIndex = Math.max(0, Math.min(currentCardIndex, currentText.length - 1));
            updateCard();
        }

        function updateCard() {
            const card = document.getElementById('flashcard');
            if (currentCardIndex >= 0 && currentCardIndex < currentText.length) {
                card.textContent = currentText[currentCardIndex];
                card.dataset.pinyin = showPinyin ? getPinyin(currentText[currentCardIndex]) : '';
            }
        }

        function flipCard() {
            const card = document.getElementById('flashcard');
            card.textContent = card.textContent === card.dataset.pinyin 
                ? currentText[currentCardIndex] 
                : card.dataset.pinyin;
        }

        // Fill-in-the-Blank Module
        function initFillInBlank() {
            blankPositions = [];
            const exercise = currentText.map((char, i) => {
                if (i % 3 === 0) {
                    blankPositions.push(i);
                    return '_';
                }
                return char;
            }).join('');
            document.getElementById('blank-exercise').textContent = exercise;
        }

        function checkBlank() {
            const userAnswers = document.getElementById('blank-input').value.split('');
            const display = currentText.map((char, i) => {
                const blankIndex = blankPositions.indexOf(i);
                if (blankIndex > -1) {
                    const userChar = userAnswers[blankIndex] || '_';
                    const cls = userChar === char ? 'correct' : 'incorrect';
                    return `<span class="${cls}">${userChar}</span>`;
                }
                return char;
            }).join('');
            
            document.getElementById('blank-exercise').innerHTML = display;
        }

        // Typing & Voice Module
        function initTypingPractice() {
            document.getElementById('typing-prompt').textContent = currentText.join('');
            document.getElementById('typing-input').value = '';
            document.getElementById('typing-input').oninput = function(e) {
                highlightComparison(currentText.join(''), e.target.value);
            }
        }

        function startVoiceInput() {
            if (window.location.protocol !== 'https:') {
                alert("è¯­éŸ³è¾“å…¥éœ€è¦HTTPSå®‰å…¨è¿æ¥!");
                return;
            }

            if (!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) {
                alert("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¾“å…¥!");
                return;
            }

            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'zh-CN';
            recognition.continuous = false;
            
            recognition.onresult = (event) => {
                const result = event.results[0][0].transcript;
                document.getElementById('typing-input').value = result;
                highlightComparison(currentText.join(''), result);
            };

            recognition.onerror = (event) => {
                document.getElementById('voice-status').textContent = `é”™è¯¯: ${event.error}`;
            };

            recognition.onend = () => {
                document.getElementById('voice-status').textContent = "";
            };

            recognition.start();
            document.getElementById('voice-status').textContent = "æ­£åœ¨è†å¬...";
        }

        // Text Comparison
        function showOriginalText() {
            document.getElementById('original-text').textContent = currentText.join('');
        }

        function highlightComparison(original, userInput) {
            const userDisplay = document.getElementById('user-text');
            userDisplay.innerHTML = Array.from(userInput).map((c, i) => {
                const originalChar = original[i] || '';
                return `<span class="${originalChar === c ? 'correct' : 'incorrect'}">${c}</span>`;
            }).join('');
        }

        // Pinyin Conversion
        function getPinyin(char) {
            if (!window.pinyinPro) {
                console.error("æ‹¼éŸ³åº“æœªæ­£ç¡®åŠ è½½!");
                return char;
            }
            return window.pinyinPro.convertToPinyin(char, ' ', true, true) || char;
        }

        // Social Sharing
        function shareProgress() {
            const text = `æˆ‘æ­£åœ¨ç»ƒä¹ ä¸­æ–‡ï¼š${currentText.slice(0, 20).join('')}...\nè¯•è¯•è¿™ä¸ªå·¥å…·ï¼š${location.href}`;
            
            if (navigator.share) {
                navigator.share({ text }).catch(() => {
                    prompt("è¯·æ‰‹åŠ¨å¤åˆ¶åˆ†äº«å†…å®¹:", text);
                });
            } else if (navigator.clipboard) {
                navigator.clipboard.writeText(text)
                    .then(() => alert("å·²å¤åˆ¶åˆ†äº«é“¾æ¥åˆ°å‰ªè´´æ¿!"))
                    .catch(() => prompt("å¤åˆ¶ä»¥ä¸‹å†…å®¹åˆ†äº«:", text));
            } else {
                prompt("å¤åˆ¶ä»¥ä¸‹å†…å®¹åˆ†äº«:", text);
            }
        }

        // Session Persistence
        window.addEventListener('load', () => {
            const savedText = sessionStorage.getItem('currentText');
            if (savedText) {
                try {
                    document.getElementById('input-text').value = JSON.parse(savedText).join('');
                    processText();
                } catch (e) {
                    sessionStorage.removeItem('currentText');
                }
            }
        });

        // Error Handling
        window.addEventListener('error', (e) => {
            console.error(e);
            alert(`æ“ä½œå¤±è´¥: ${e.message}`);
        });

        // Load Pinyin Library
        (function loadPinyin() {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/pinyin-pro@3.14.3/dist/web/pinyin-pro.js';
            script.integrity = "sha384-4X6YVJgD4jC9T/3+5E6Xp4Z5XpwQwLSP7Fxvu0Zwr0Y0SOU5N6TZQ5fJ5Z5C5A==";
            script.crossOrigin = "anonymous";
            script.async = true;
            script.onerror = () => {
                alert("æ‹¼éŸ³åº“åŠ è½½å¤±è´¥ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½å—é™!");
            };
            document.head.appendChild(script);
        })();
    </script>
</body>
</html>
